<head>
    <style>
        /* This will be move into the object */
        .airport {
            fill: purple;
        }
        .divFromPort{
            /* Divert from airport */
            fill: red;
        }
        .divToPort{
            /* Divert to airport */
            stroke: lime;
            stroke-opacity: 0.5;
            stroke-width: 200px;
        }

        .fix {
            fill: lime;
        }

        .flight {
            fill: limegreen;
            stroke: black;
            stroke-width: 10px;
        }
        .highlight {
            stroke: limegreen;
            stroke-opacity: 0.5;
            stroke-width: 200px;
        }
        .divert {
            fill: red;
            stroke: yellow;
            stroke-opacity: 0.5;
            stroke-width: 200px;
        }
    </style>
    <style>
        /* This will stay here */
        body {
            padding: 0;
            margin: 0;
        }

        div {
            z-index: 6;
            position: fixed;
            display: block;
        }
    </style>
</head>

<body>
    <div>
        <input type="text" id="divertAirport">
        <button onclick="divert()">Divert</button>
        <p id="info"></p>
    </div>
    <object id="obj" width="100%" type="image/svg+xml" data="Union-aviation-map.svg"></object>
</body>

<script>
    const Delta = 0.1; // how much a tick represent compare to the unit (per hour)
    const PI = Math.PI,
        sqrt = Math.sqrt,
        sin = Math.sin,
        cos = Math.cos,
        atan2 = Math.atan2,
        abs = Math.abs,
        min = Math.min,
        max = Math.max,
        random = Math.random,
        floor = Math.floor;
        const toRad = x => x * PI / 180,
        toDeg = x => x * 180 / PI;
        const nm = 1.852; // nautical miles factor

        // utils
    const randomItem = arr => arr[floor((random() * arr.length))];
    const randomName = (len, mode) => {
        const letter = 'abcdefghijklmnopqrstuvwxyz',
        num = '0123456789';

        let chars = ''
        if (mode == 'l') chars = letter;
        else if (mode == 'n') chars = num;
        else chars = letter + num;

        let out = ''
        for (let l1 = 0; l1 < len; l1++) out += randomItem(chars);
        return out;
    }

    let canvas = document.getElementById('obj');
    canvas.addEventListener('load', () => {
        canvas = canvas.contentDocument;

        // copy style
        canvas.documentElement.append(document.querySelector('style'))

        // initialize
        for (const fix of canvas.querySelectorAll('circle')) {
            new Fix(
                Number(fix.getAttribute('cx')),
                Number(fix.getAttribute('cy')),
                fix.getAttribute('inkscape:label'),
                fix.parentElement.getAttribute('inkscape:label') == 'Airport'
            )
            fix.remove()
        }

        // convert and validate plan
        for (let l1 in Flight.plan) {
            Flight.plan[l1] = Flight.plan[l1].split('-');
            for (const fix of Flight.plan[l1])
                if (!(fix in Fix.list)) console.log(fix + ' is invalid')
            Flight.plan.push(Flight.plan[l1].toReversed())
        }
    })

    class Vector {
        #dir = 0;
        get dir() {
            return this.#dir;
        }
        set dir(x) {
            if (x < 0) x = 360 * 10 - abs(x) ; // dumb patch work
            this.#dir = x % 360;
        }
        constructor(length, direction) {
            if (typeof length != "number" || typeof direction != "number")
                throw TypeError('Vector constructor must be a number');
            this.len = length;
            this.dir = direction;
        }
        toPoint() {
            // convert to the next relative points
            // cos theta = (x/l)
            let dir = this.dir, len = this.len;
            return {
                x: cos(toRad(dir)) * len,
                y: sin(toRad(dir)) * len
            }
        }
        static fromPoints(p1, p2) {
            // generate vector from points
            let x = p2.x - p1.x, y = p2.y - p1.y;
            return new Vector(
                sqrt(x*x + y*y),
                toDeg(atan2(y, x))
            );
        }
        copy() {
            return new Vector(this.len, this.dir)
        }
        dirDiff(v2) {
            // difference dir between two vectors
            let d = this.dir - v2.dir; // difference between expected place
            if (abs(d) > 180)
                d = v2.dir - this.dir
            return d;
        }
    }

    class Fix {
        static airport = []
        static list = {}
        constructor(x, y, name, isAirport) {
            this.x = x;
            this.y = y;
            this.name = name || randomName(5).toUpperCase();
            this.isAirport = Boolean(isAirport);

            Fix.list[this.name] = this;
            if (isAirport) {
                Fix.airport.push(this)
                this.elm = canvas.createElementNS('http://www.w3.org/2000/svg', 'circle');
                this.elm.setAttribute('cx', x);
                this.elm.setAttribute('cy', y);
                this.elm.setAttribute('r', 100);
            } else {
                this.elm = canvas.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                this.elm.setAttribute('points', `${x},${y-100} ${x+100},${y+100} ${x-100},${y+100}`)
            }
            this.elm.setAttribute('id', this.name);
            this.elm.setAttribute('class', isAirport? 'airport': 'fix');
            this.elm.addEventListener('click', () => {
                for (let l1 in Flight.list) {
                    if (Flight.list[l1].plan.includes(Fix.list[name]))
                        Flight.list[l1].elm.classList.add('highlight')
                }
                document.getElementById('info').innerText = 'Highlighted flights to/via ' + name;
            })

            canvas.documentElement.append(this.elm);
        }
    }

    class Flight {
        static plan = [
            'A0E-ESAT',
            'A0E-OLFA',
            'A0E-VGJA',
            'A0E-WHPG',
            'A0N-MIFM',
            'A0N-OLFA',
            'A0N-HAKAI-ESAT',
            'A0N-HAKAI-WHPG',
            'A0W-BBED',
            'A0W-BLTT',
            'A0W-ESAT',
            'A0W-WHPG',
            'A0W-HAKAI-MIFM',
            'A0S-ESAT',
            'A0S-WHPG',
            'A0S-HAKAI-MIFM',
            'ANE-MIFM',
            'ANE-OLFA',
            'ANE-VGJA',
            'ANE-WHPG',
            'AWN-BAKAI-ESAT',

            'BBED-BLTT',
            'BBED-OFHR',
            'BBED-WHPG',
            'BBED-BAKAI-ESAT',
            'BLTT-OFHR',
            'BLTT-WHPG',
            'BLTT-BAKAI-VGJA',
            'BLTT-BAKAI-ESAT',
            'BLTT-BAKAI-HAKAI-MIFM',
            'BLTT-BAKAI-HAKAI-OLFA',
            'ESAT-WHPG',
            'ESAT-YSHL',
            'ESAT-HAKAI-VGJA',
            'GEHV-GUST',
            'GEHV-OLFA',
            'GUST-WHPG',
            'GUST-KALOU-YSHL',
            'MIFM-OLFA',
            'MIFM-HAKAI-ESAT',
            'MIFM-HAKAI-OFHR',
            'MIFM-HAKAI-WHPG',
            'MIFM-HAKAI-YSHL',
            'OLFA-VGJA',
            'OLFA-WHPG',
            'OLFA-HAKAI-OFHR',
            'VGJA-WHPG',
            'WHPG-YSHL',
        ]
        static list = [];
        constructor(plan, speed, callsign) {
            this.plan = []
            for (let l1 in plan)
                this.plan.push(Fix.list[plan[l1]]);
            this.speed = speed;
            this.callsign = callsign || (randomItem(['EI'])) + randomName(4, 'n');
            this.divert = false;

            this.x = this.plan[0].x; this.y = this.plan[0].y;
            this.plan.shift(); // remove depart airport

            Flight.list.push(this);

            this.elm = canvas.createElementNS('http://www.w3.org/2000/svg', 'circle');
            this.elm.setAttribute('id', this.callsign);
            this.elm.setAttribute('class', 'flight');
            this.elm.setAttribute('cx', 0); // this.tick() will deal with it
            this.elm.setAttribute('cy', 0);
            this.elm.setAttribute('r', 50);
            canvas.documentElement.append(this.elm)

            this.tick()
        }
        tick() {
            // move to the next tick
            if (this.divert) {
                // find the closest airport
                this.plan = []; // clear

                let min = Infinity, minName = '';
                for (const airport of Fix.airport) {
                    let vec = Vector.fromPoints(this, airport);
                    if (vec.len < min) {
                        min = vec.len;
                        minName = airport.name;
                    }
                }

                this.plan.push(Fix.list[minName])
                this.elm.classList.add('divert')
            }

            let vec = Vector.fromPoints(this, this.plan[0]);

            if (vec.len < nm) {
                this.plan.shift();
                if (this.plan.length == 0) return true;
                vec = Vector.fromPoints(this, this.plan[0]);
            }

            vec.len = min(this.speed * Delta, vec.len);
            vec = vec.toPoint();
            this.x += vec.x;
            this.y += vec.y;

            this.elm.setAttribute('cx', this.x);
            this.elm.setAttribute('cy', this.y);
        }
    }

    let allowTakeoff = true;

    function divert() {
        let divertAirport = document.getElementById('divertAirport').value;
        divertAirport = divertAirport.split('-');

        // change enroute plan destination
        for (const l1 in Flight.list)
            if (Flight.list[l1].plan.at(-1).name == divertAirport[0]) {
                Flight.list[l1].elm.classList.add('divert')
                Flight.list[l1].divert = true;
            }

        // change flight plan
        for (const l1 in Flight.plan)
            for (const l2 in Flight.plan[l1])
                if (Flight.plan[l1][l2] == divertAirport[0])
                    Flight.plan[l1][l2] = divertAirport[1];

        // change airport style
        Fix.list[divertAirport[0]].elm.classList.add('divFromPort');
        Fix.list[divertAirport[1]].elm.classList.add('divToPort');
    }

    let sim = setInterval(() => {
        for (let l1 = 0; l1 < Flight.list.length; l1++) {
            const flight = Flight.list[l1];
            if (flight.plan.length <= 0 || flight.tick()) {
                flight.elm.remove();
                Flight.list.splice(l1, 1);
                l1--
            }
        }

        if (allowTakeoff)
            new Flight(
                randomItem(Flight.plan),
                300 + random() * 500
            );

        if (random() < 0.025)
            randomItem(Flight.list).divert = true;
    }, 1000 * Delta);
</script>